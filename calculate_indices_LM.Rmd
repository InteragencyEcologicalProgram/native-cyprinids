---
title: "calculate_indices"
author: "Catarina Pien"
date: '2022-10-07'
output: html_document
editor_options: 
  chunk_output_type: console
---
# Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')
if (!require('patchwork')) install.packages('patchwork'); library('patchwork')
if (!require('lubridate')) install.packages('lubridate'); library('lubridate')
if (!require('odbc')) install.packages('odbc'); library('odbc') # database functions
if (!require('Kendall')) install.packages('Kendall'); library('Kendall')
if (!require('car')) install.packages('car'); library('car')
if (!require('MuMIn')) install.packages('MuMIn'); library('MuMIn')
if (!require('lme4')) install.packages('lme4'); library('lme4')
if (!require('afex')) install.packages('afex'); library('afex')
if (!require('trend')) install.packages('trend'); library('trend')
if (!require('rms')) install.packages('rms'); library('rms')
if (!require('mgcv')) install.packages('mgcv'); library('mgcv')
if (!require('leaflet')) install.packages('leaflet'); library('leaflet')
if (!require('viridis')) install.packages('viridis'); library('viridis')
options(scipen=999) # Getting rid of scientific notation
windowsFonts(Times = windowsFont("Times New Roman"))
```

# Bring in data
```{r}
# read in catch data
data <- readRDS("data_clean/seine_djfmp_ybfmp.rds")
summary(data)

# add year column
data$Year <- format(data$SampleDate, format="%Y")

## Subset by year:
range(data$SampleDate)

data <- data %>%
  filter(1995 <= Year & Year <= 2019)


# read in discharge data from DAYFLOW
## needs updating through 2021, maybe?

Discharge <- 
  read.csv("data/dayflow_1994_2019.csv")
Discharge$Year <- as.factor(Discharge$Year)
Discharge$Mo <- as.factor(Discharge$Mo)

# read in river mile data - Will be used to determine center of distribution 
## needs updating to reflect YBFMP sites and maybe DJFMP data that was filtered out in prior versions?
Site_RM <- 
  read.csv("Data/Site_Coords.csv")

# Retrieve site coordinates for mapping:
djfmp_site_file <- contentid::resolve("hash://sha256/f0f9e66da7415df90a7c0ea4c01938ecadd71ad412af1ccc940e861e63e96ba7")
djfmp_sites0 <- read_csv(djfmp_site_file)

ybfmp_sites_file <- contentid::resolve("hash://sha256/acc9940abf5662e81ee594553e7dc46a05c4cace9c924dbf5352c0544bc7a481")
ybfmp_sites0 <- read_csv(ybfmp_sites_file)

any(duplicated(djfmp_sites0$StationCode, ybfmp_sites0$StationCode)) # should be FALSE

all_site_coordinates <- rbind(djfmp_sites0[ ,c("StationCode","Latitude","Longitude")],
                              ybfmp_sites0[ ,c("StationCode","Latitude","Longitude")])
```

# Create species datasets
```{r}
# SACPIK Data ---------------------------------------------------------------

data_SACPIK <- 
  data %>% 
  filter(!(is.na(Volume))) %>% # Removing samples without volume data
  select(EventID, Location, RegionCode, StationCode, SampleDate, Datetime, 
         Year, Month, Jday, IEPFishCode, ForkLength, CountAdj, Volume, DO, WaterTemp, 
         Turbidity, Secchi, SpecificConductance, GearConditionCode) %>% 
  filter(IEPFishCode == "SACPIK") %>%  # Only keeping catch for SACPIK
  mutate(IEPFishCode = as.character(IEPFishCode))
head(data_SACPIK)
str(data_SACPIK)

# SPLT Data ---------------------------------------------------------------

data_SPLITT <- 
  data %>% 
  filter(!(is.na(Volume))) %>% # Removing samples without volume data
  select(EventID, Location, RegionCode, StationCode, SampleDate, Datetime, 
         Year, Month, Jday, IEPFishCode, ForkLength, CountAdj, Volume, DO, WaterTemp, 
         Turbidity, Secchi, SpecificConductance, GearConditionCode) %>% 
  filter(IEPFishCode == "SPLITT") %>%  # Only keeping catch for SACPIK
  mutate(IEPFishCode = as.character(IEPFishCode))
head(data_SPLITT)
str(data_SPLITT)

# SASU Data ---------------------------------------------------------------

data_SACSUC <- 
  data %>% 
  filter(!(is.na(Volume))) %>% # Removing samples without volume data
  select(EventID, Location, RegionCode, StationCode, SampleDate, Datetime, 
         Year, Month, Jday, IEPFishCode, ForkLength, CountAdj, Volume, DO, WaterTemp, 
         Turbidity, Secchi, SpecificConductance, GearConditionCode) %>% 
  filter(IEPFishCode == "SACSUC") %>%  # Only keeping catch for SACPIK
  mutate(IEPFishCode = as.character(IEPFishCode))
head(data_SACSUC)
str(data_SACSUC)
```

# Filter species datasets to appropriate months, sizes (Age-0)

```{r}
## Code in this section was unintentionally removing samples with zero age-0 catch,
## and calculating CPUE by sample-fork length combination rather than by sample only.

# SACPIK Data ---------------------------------------------------------------
# Based on length frequency histograms - age 0 make up majority of catch during these months 
# Filter to June + July, >24mm, <61 in June and <71 in July

# data_SACPIK_age0 <- data_SACPIK %>%
#   filter(Month %in% c(6, 7),
#          ForkLength > 24,
#          case_when(Month == 6 ~ ForkLength < 61,
#                    Month == 7 ~ ForkLength < 71 )) %>%
#   mutate(CPUE = CountAdj/Volume,
#          Volume_Z = scale(Volume),
#          Julian_Z = scale(Jday),
#          Julian_Sq_Z = scale(Jday^2))

data_SACPIK_age0 <- data_SACPIK %>%
  filter(Month %in% c(6, 7)) %>%
	mutate(Age0=( (Month == 6 & 24 < ForkLength & ForkLength < 61) |
									(Month == 7 & 24 < ForkLength & ForkLength < 71) )) %>%
	group_by(EventID, Location, RegionCode, StationCode, SampleDate, Datetime, Year,
					 Month, Jday, Volume, DO, WaterTemp, Turbidity, Secchi, 
					 SpecificConductance, GearConditionCode) %>%
	summarise(TotalCountAdj_age0=sum(CountAdj[Age0]),
						.groups="drop") %>%
  mutate(CPUE = TotalCountAdj_age0/Volume,
         Volume_Z = scale(Volume),
         Julian_Z = scale(Jday),
         Julian_Sq_Z = scale(Jday^2))

## Double check that all fish are represented:
tmp <- data_SACPIK %>%
  filter(Month %in% c(6, 7)) %>%
	mutate(Age0=( (Month == 6 & 24 < ForkLength & ForkLength < 61) |
									(Month == 7 & 24 < ForkLength & ForkLength < 71) ))
stopifnot(sum(data_SACPIK_age0$TotalCountAdj_age0) == sum(tmp$CountAdj[tmp$Age0]))



# SPLITT Data ---------------------------------------------------------------
# Based on length frequency histograms - age 0 make up majority of catch during these months 
# Filter to May + June, >24mm, <51 in May and <66 in June

# data_SPLITT_age0 <- data_SPLITT %>%
#   filter(Month %in% c(5,6),
#          ForkLength > 24,
#          case_when(Month == 5 ~ ForkLength < 50,
#                    Month == 6 ~ ForkLength < 61 )) %>%
#   mutate(CPUE = CountAdj/Volume,
#          Volume_Z = scale(Volume),
#          Julian_Z = scale(Jday),
#          Julian_Sq_Z = scale(Jday^2))

data_SPLITT_age0 <- data_SPLITT %>%
  filter(Month %in% c(5, 6)) %>%
	mutate(Age0=( (Month == 5 & 24 < ForkLength & ForkLength < 50) | 
									(Month == 6 & 24 < ForkLength & ForkLength < 61) )) %>%
	group_by(EventID, Location, RegionCode, StationCode, SampleDate, Datetime, Year,
					 Month, Jday, Volume, DO, WaterTemp, Turbidity, Secchi, 
					 SpecificConductance, GearConditionCode) %>%
	summarise(TotalCountAdj_age0=sum(CountAdj[Age0]),
						.groups="drop") %>%
  mutate(CPUE = TotalCountAdj_age0/Volume,
         Volume_Z = scale(Volume),
         Julian_Z = scale(Jday),
         Julian_Sq_Z = scale(Jday^2))

## Double check that all fish are represented:
tmp <- data_SPLITT %>%
  filter(Month %in% c(5, 6)) %>%
	mutate(Age0=( (Month == 5 & 24 < ForkLength & ForkLength < 50) | 
									(Month == 6 & 24 < ForkLength & ForkLength < 61) ))
stopifnot(sum(data_SPLITT_age0$TotalCountAdj_age0) == sum(tmp$CountAdj[tmp$Age0]))



# SACSUC --------------------------------------------------------------------
# Based on length frequency histograms - age 0 make up majority of catch during these months 
# Filter to May + June, >24mm, <51 in May and <66 in June

# data_SACSUC_age0 <- data_SACSUC %>%
#   filter(Month %in% c(5,6, 12),
#          ForkLength > 24,
#          case_when(Month == 5 ~ ForkLength < 51,
#                    Month %in% c(12, 6) ~ ForkLength < 66 )) %>%
#   mutate(CPUE = CountAdj/Volume,
#          Volume_Z = scale(Volume),
#          Julian_Z = scale(Jday),
#          Julian_Sq_Z = scale(Jday^2))

data_SACSUC_age0 <- data_SACSUC %>%
  filter(Month %in% c(5, 6)) %>%
	mutate(Age0=( (Month == 5 & 24 < ForkLength & ForkLength < 51) | 
									(Month == 6 & 24 < ForkLength & ForkLength < 66) )) %>%
	group_by(EventID, Location, RegionCode, StationCode, SampleDate, Datetime, Year,
					 Month, Jday, Volume, DO, WaterTemp, Turbidity, Secchi, 
					 SpecificConductance, GearConditionCode) %>%
	summarise(TotalCountAdj_age0=sum(CountAdj[Age0]),
						.groups="drop") %>%
  mutate(CPUE = TotalCountAdj_age0/Volume,
         Volume_Z = scale(Volume),
         Julian_Z = scale(Jday),
         Julian_Sq_Z = scale(Jday^2))

## Double check that all fish are represented:
tmp <- data_SACSUC %>%
  filter(Month %in% c(5, 6)) %>%
	mutate(Age0=( (Month == 5 & 24 < ForkLength & ForkLength < 51) | 
									(Month == 6 & 24 < ForkLength & ForkLength < 66) ))
stopifnot(sum(data_SACSUC_age0$TotalCountAdj_age0) == sum(tmp$CountAdj[tmp$Age0]))

```

# Region designations

```{r}
## DJFMP region codes:
## 1 = Sacramento River
## 2, 3, 4, 7 = Delta
## 6 = SF Bay (should not appear in the data at this point)
## 5 = San Joaquin

# Complete set of regions:
all_regions <- c("Sacramento","Yolo","Delta","San_Joaquin")

# SACPIK Data ---------------------------------------------------------------
data_SACPIK_age0 <- data_SACPIK_age0 %>%
  mutate(Region = case_when(RegionCode %in% c(1) ~ "Sacramento",
                            RegionCode %in% c(2,3,4,7) ~ "Delta",
                            RegionCode %in% c(5) ~ "San_Joaquin",
                            grepl("YBFMP", EventID) ~ "Yolo"))

# SPLITT Data ---------------------------------------------------------------
data_SPLITT_age0 <- data_SPLITT_age0 %>%
  mutate(Region = case_when(RegionCode %in% c(1) ~ "Sacramento",
                            RegionCode %in% c(2,3,4,7) ~ "Delta",
                            RegionCode %in% c(5) ~ "San_Joaquin",
                            grepl("YBFMP", EventID) ~ "Yolo"))

# SACSUC --------------------------------------------------------------------
data_SACSUC_age0 <- data_SACSUC_age0 %>%
  mutate(Region = case_when(RegionCode %in% c(1) ~ "Sacramento",
                            RegionCode %in% c(2,3,4,7) ~ "Delta",
                            RegionCode %in% c(5) ~ "San_Joaquin",
                            grepl("YBFMP", EventID) ~ "Yolo"))


## Check region designations by mapping:
stopifnot(sum(is.na(data_SACPIK_age0$Region)) == 0)
stopifnot(sum(is.na(data_SPLITT_age0$Region)) == 0)
stopifnot(sum(is.na(data_SACSUC_age0$Region)) == 0)

## Compile unique sites represented in the final data sets and check region assignments:
uniq_sites_in_data <- do.call("rbind", list(data_SACPIK_age0, 
                                            data_SPLITT_age0,
                                            data_SACSUC_age0)) %>%
  mutate(Program=gsub("(.*)_(.*)","\\1",EventID)) %>%
  distinct(Program, Location, StationCode, Region) %>%
  left_join(all_site_coordinates, by="StationCode") %>%
  mutate(Region_f = factor(Region, levels=all_regions, ordered=TRUE))

pal <- leaflet::colorFactor(viridis::turbo(256), uniq_sites_in_data$Region_f)

uniq_sites_in_data %>%
  leaflet::leaflet() %>%
  leaflet::addTiles() %>%
  leaflet::addCircleMarkers(
    color = ~pal(Region_f),
    stroke = FALSE,
    fillOpacity = 1,
    radius = 4, 
    lng = ~Longitude,
    lat = ~Latitude,
    label = ~StationCode) %>%
  leaflet::addLegend(
    title = "Region",
    pal = pal, 
    values = ~Region_f,
    position = "bottomright",
    opacity = 1)

```

# Calculate Regional and System Wide Indices

```{r}
# SACPIK Data ---------------------------------------------------------------
SACPIK_Index_Final <-
  data_SACPIK_age0 %>%
  group_by(StationCode, Year, Month, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  group_by(Year, Month, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  group_by(Year, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  mutate(CPUE = ifelse(is.nan(CPUE), NA, CPUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(id_cols=Year,
                     names_from=Region,
                     values_from=CPUE,
                     names_prefix="Index_") %>%
  mutate(Index_Watershed=Index_Delta + Index_Sacramento + 
                            Index_San_Joaquin + Index_Yolo)
  # spread(Region, CPUE)

# SACPIK_Index_Final$Delta_Index = SACPIK_Index_Final$Delta
# SACPIK_Index_Final$Sacramento_Index = SACPIK_Index_Final$Sacramento
# SACPIK_Index_Final$San_Joaquin_Index = SACPIK_Index_Final$San_Joaquin
# SACPIK_Index_Final$Watershed_Index = rowSums(SACPIK_Index_Final[,2:4])
# 
# SACPIK_Index_Final <- 
#   SACPIK_Index_Final[,c(1,5:8)]
head(SACPIK_Index_Final)

#write.csv(SACPIK_Index_Final, "Output/SACPIK_Index_Final.csv", row.names = FALSE)

# SPLITT Data ---------------------------------------------------------------
SPLITT_Index_Final <-
  data_SPLITT_age0 %>%
  #filter(subarea != 8) %>%
  group_by(StationCode, Year, Month, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  group_by(Year, Month, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  group_by(Year, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  mutate(CPUE = ifelse(is.nan(CPUE), NA, CPUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(id_cols=Year,
                     names_from=Region,
                     values_from=CPUE,
                     names_prefix="Index_") %>%
  mutate(Index_Watershed=Index_Delta + Index_Sacramento + 
                            Index_San_Joaquin + Index_Yolo)
  # spread(Region, CPUE)

# SPLITT_Index_Final$Delta_Index = SPLITT_Index_Final$Delta
# SPLITT_Index_Final$Sacramento_Index = SPLITT_Index_Final$Sacramento
# SPLITT_Index_Final$San_Joaquin_Index = SPLITT_Index_Final$San_Joaquin
# SPLITT_Index_Final$Watershed_Index = rowSums(SPLITT_Index_Final[,2:4])
# 
# SPLITT_Index_Final <- 
#   SPLITT_Index_Final[,c(1,5:8)]
head(SPLITT_Index_Final)

#write.csv(SPLITT_Index_Final, "Output/SPLITT_Index_Final.csv", row.names = FALSE)

# SACSUC Data ---------------------------------------------------------------

SACSUC_Index_Final <-
  data_SACSUC_age0 %>%
  filter(Month != 12) %>% # Removing December
  group_by(StationCode, Year, Month, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  group_by(Year, Month, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  group_by(Year, Region) %>% 
  summarise(CPUE = mean(CPUE)) %>% 
  mutate(CPUE = ifelse(is.nan(CPUE), NA, CPUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(id_cols=Year,
                     names_from=Region,
                     values_from=CPUE,
                     names_prefix="Index_") %>%
  mutate(Index_Watershed=Index_Delta + Index_Sacramento + 
                            Index_San_Joaquin + Index_Yolo)
  # spread(Region, CPUE)

# SACSUC_Index_Final$Delta_Index = SACSUC_Index_Final$Delta
# SACSUC_Index_Final$Sacramento_Index = SACSUC_Index_Final$Sacramento
# SACSUC_Index_Final$San_Joaquin_Index = SACSUC_Index_Final$San_Joaquin
# SACSUC_Index_Final$Watershed_Index = rowSums(SACSUC_Index_Final[,2:4])
# 
# SACSUC_Index_Final <- 
#   SACSUC_Index_Final[,c(1,5:8)]
head(SACSUC_Index_Final)

#write.csv(SACSUC_Index_Final, "Output/SACSUC_Index_Final.csv", row.names = FALSE)


p_SACPIK <- SACPIK_Index_Final %>%
  tidyr::pivot_longer(cols=-Year, names_to="Region", values_to="Index",
                      names_prefix="Index_") %>%
  dplyr::mutate(Region_f=factor(Region, levels=c(all_regions,"Watershed"), 
                                ordered=TRUE)) %>%
  ggplot() + 
    geom_col(aes(x=Year, y=Index)) + 
    facet_grid(rows=vars(Region_f), scales="free_y") + 
    #scale_y_continuous(limits=c(0, NA), expand=c(0,0)) + 
    scale_x_discrete(breaks=seq(1995, 2019, by=2)) + 
    ggtitle("Pikeminnow")
p_SACPIK 


p_SPLITT <- SPLITT_Index_Final %>%
  tidyr::pivot_longer(cols=-Year, names_to="Region", values_to="Index",
                      names_prefix="Index_") %>%
  dplyr::mutate(Region_f=factor(Region, levels=c(all_regions,"Watershed"), 
                                ordered=TRUE)) %>%
  ggplot() + 
    geom_col(aes(x=Year, y=Index)) + 
    facet_grid(rows=vars(Region_f), scales="free_y") + 
    scale_x_discrete(breaks=seq(1995, 2019, by=2)) + 
  ggtitle("Splittail")
p_SPLITT


p_SACSUC <- SACSUC_Index_Final %>%
  tidyr::pivot_longer(cols=-Year, names_to="Region", values_to="Index",
                      names_prefix="Index_") %>%
  dplyr::mutate(Region_f=factor(Region, levels=c(all_regions,"Watershed"), 
                                ordered=TRUE)) %>%
  ggplot() + 
    geom_col(aes(x=Year, y=Index)) + 
    facet_grid(rows=vars(Region_f), scales="free_y") + 
    scale_x_discrete(breaks=seq(1995, 2019, by=2)) + 
  ggtitle("Sucker")
p_SACSUC


pdf("Figures/index_figures.pdf",onefile = TRUE)
  p_SACPIK
  p_SPLITT
  p_SACSUC
dev.off()

```

# Calculate Center of Distribution: Line 745

* Calculated using the months used to make the indices
* Formula taken from Sommer et al. 2011
* CD = sum(RiverKilo * CPUE)/sum(CPUE)
* Going to be used as response variable in model with flow/timing/temp as covariates (below)


* Could make this code much shorter - group by Region and year and calculate? It seems now we are using the station name to determine region. 
```{r}
SACSUC_RM <- 
  data_SACSUC_age0 %>% 
  left_join(Site_RM, 
            by = "StationCode") %>% 
  filter(CPUE != 0) # Removing records where CPUE was 0. This will prevent NAs in SJ when there were years w/ 0 catch (OW 0 CPUE shouldn't matter)

# Sacramento River
SACSUC_RM_Sac <-
  SACSUC_RM %>% 
  filter(grepl("SR", StationCode)) # Selecting stations that begin w/ SR
head(SACSUC_RM_Sac)

# SJ River
SACSUC_RM_SJ <-
  SACSUC_RM %>% 
  filter(grepl("SJ", StationCode)) # Selecting stations that begin w/ SJ
head(SACSUC_RM_SJ)

SACSUC_CDist_SAC <- 
  SACSUC_RM_Sac %>% 
  filter(Year %in% c(1995:2019)) %>% 
  group_by(Year) %>% 
  summarise(CDist_SAC = sum(RiverKilo * CPUE)/sum(CPUE))
head(SACSUC_CDist_SAC)

SACSUC_Month_CDist_SAC <- 
  SACSUC_RM_Sac %>% 
  filter(Year %in% c(1995:2019)) %>% 
  group_by(Year, 
           Month) %>% 
  summarise(CDist_SAC = sum(RiverKilo * CPUE)/sum(CPUE))
head(SACSUC_Month_CDist_SAC)

SACSUC_CDist_SJ <- 
  SACSUC_RM_SJ %>% 
  filter(Year %in% c(1995:2019)) %>% 
  group_by(Year) %>% 
  summarise(CDist_SJ = sum(RiverKilo * CPUE)/sum(CPUE))
head(SACSUC_CDist_SJ)

SACSUC_CDist <- 
  SACSUC_CDist_SAC %>% 
  left_join(SACSUC_CDist_SJ,
            by = "Year")
head(SACSUC_CDist)
```


